name: .NET CI/CD for UserService

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Create nuget.config for private packages
      run: |
        echo "<?xml version=\"1.0\" encoding=\"utf-8\"?>
        <configuration>
          <packageSources>
            <add key=\"nuget.org\" value=\"https://api.nuget.org/v3/index.json\" protocolVersion=\"3\" />
            <add key=\"github\" value=\"https://nuget.pkg.github.com/d1amond09/index.json\" />
          </packageSources>
          <packageSourceCredentials>
            <github>
              <add key=\"Username\" value=\"d1amond09\" />
              <add key=\"ClearTextPassword\" value=\"${{ secrets.PAT_FOR_NUGET }}\" />
            </github>
          </packageSourceCredentials>
        </configuration>" > nuget.config
    
    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

    - name: Test
      run: dotnet test --no-build --verbosity normal --configuration Release 
      
  build-and-push-docker:
    needs: build-and-test 
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4 

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3 

    - name: Login to Docker Hub
      uses: docker/login-action@v3 
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
          
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: . 
        file: ./UserService.API/Dockerfile 
        push: true 
        tags: d1amond9/user-service-api:latest
        secrets: |
          "nugetconfig=<?xml version=\"1.0\" encoding=\"utf-8\"?>
          <configuration>
            <packageSources>
              <add key=\"nuget.org\" value=\"https://api.nuget.org/v3/index.json\" protocolVersion=\"3\" />
              <add key=\"github\" value=\"https://nuget.pkg.github.com/d1amond09/index.json\" />
            </packageSources>
            <packageSourceCredentials>
              <github>
                <add key=\"Username\" value=\"d1amond09\" />
                <add key=\"ClearTextPassword\" value=\"${{ secrets.PAT_FOR_NUGET }}\" />
              </github>
            </packageSourceCredentials>
          </configuration>"
          
    - name: Complete workflow
      run: echo "Workflow completed successfully!"
